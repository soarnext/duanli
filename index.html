<!DOCTYPE HTML>
<html>
	<head>
		<title>链接生成器</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />
	</head>
	<body class="is-preload">

		<!-- This script will handle the redirection if an 'id' is present -->
		<script>
			(function() {
				const params = new URLSearchParams(window.location.search);
				const shortId = params.get('id');

				if (shortId) {
					// An ID is present, so we are in "redirect mode".
					document.title = '跳转中...';
					document.body.innerHTML = `
						<div id="tips" style="text-align: center; padding: 20px; border-radius: 8px; background-color: #fff; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);">
							<h2>正在安全跳转...</h2>
							<div class="loader" style="border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3498db; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto;"></div>
						</div>
						<style>
							@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
							body { display: flex; justify-content: center; align-items: center; background-color: #f0f2f5; color: #333; }
						</style>
					`;
					
					const ua = navigator.userAgent.toLowerCase();
					const isWeixin = ua.indexOf('micromessenger') !== -1;
					const isQQ = ua.indexOf('qq') !== -1;
					const isMobile = /iphone|ipad|ipod|android/.test(ua);

					if (isWeixin || isQQ) {
						let instructionHTML = '<h2>请在外部浏览器中打开</h2>';
						if (isMobile) {
							instructionHTML += '<p>点击右上角的菜单按钮 (通常是三个点)，<br>然后选择“在浏览器中打开”。</p>';
						} else {
							instructionHTML += `<a href="${window.location.href}" target="_blank" style="text-decoration: none; color: inherit;">
												<div style="margin-bottom: 1em; font-size: 48px;"><i class="fas fa-globe"></i></div>
												<p>请点击图标或复制网址，<br>在浏览器中打开。</p>
											 </a>`;
						}
						document.getElementById('tips').innerHTML = instructionHTML;
					} else {
						const WORKER_URL = 'https://dl.api.yxc.us.kg/';
						fetch(`${WORKER_URL}${shortId}`)
							.then(response => {
								if (!response.ok) {
									return response.json().then(err => {
										let message = '链接未找到或已失效。';
										if (err && err.error) {
											if (err.error.includes('expired')) message = '此链接已过期。';
											if (err.error.includes('maximum number of visits')) message = '此链接已达到最大访问次数。';
										}
										throw new Error(message);
									});
								}
								return response.json();
							})
							.then(data => {
								if (data && data.url) {
									window.location.href = data.url;
								} else {
									throw new Error('从服务器返回的数据格式无效。');
								}
							})
							.catch(error => {
								console.error('Redirect error:', error);
								document.getElementById('tips').innerHTML = `<h2>跳转失败</h2><p>${error.message}</p>`;
							});
					}
				}
				// If no 'id', the script does nothing and the rest of the page loads normally.
			})();
		</script>

		<!-- Main Content - This will only be visible if not redirecting -->
		<div id="main-container">
			<!-- Header -->
			<header id="header">
				<h1>链接生成器</h1>
				<p>输入您的链接，生成一个防屏蔽的短链接</p>
			</header>

			<!-- Signup Form -->
			<form id="signup-form" method="post" onsubmit="build_url(); return false;">
				<input type="url" name="url" id="url" placeholder="请输入您的长链接" />
				<input type="button" value="生成短链接" onclick="build_url()"/>
			</form>

			<!-- Advanced Options -->
			<div id="advanced-options" style="margin-top: 1em;">
				<a href="#" onclick="toggleAdvanced(); return false;" style="color: #fff; border-bottom: 1px dotted #fff;">高级选项</a>
				<div id="advanced-fields" style="display: none; margin-top: 1em; padding: 1em; background: rgba(255,255,255,0.05); border-radius: 8px;">
					<div style="margin-bottom: 1em;">
						<label for="expiresInHours" style="display: block; margin-bottom: .5em;">过期时间 (小时)</label>
						<input type="number" id="expiresInHours" value="2" min="0" style="width: 100%; background-color: rgba(255,255,255,0.1); border-radius: 6px; border: solid 1px rgba(255,255,255,0.2); padding: 0.5em;" />
					</div>
					<div>
						<label for="maxVisits" style="display: block; margin-bottom: .5em;">最大访问次数 (0 或留空表示不限制)</label>
						<input type="number" id="maxVisits" placeholder="不限制" min="0" style="width: 100%; background-color: rgba(255,255,255,0.1); border-radius: 6px; border: solid 1px rgba(255,255,255,0.2); padding: 0.5em;" />
					</div>
				</div>
			</div>

			<p id="b_url" style="margin-top: 20px;"></p>

			<script src="./assets/js/build_url.js"></script>

			<!-- Footer -->
			<footer id="footer">
				<ul class="icons">
					<li><a href="https://github.com/soarnext/soarnext.github.io" class="icon brands fa-github" target="_blank"><span class="label">GitHub</span></a></li>
				</ul>
				<ul class="copyright">
					<li>&copy; Powered by <a href="https://yxc.us.kg" target="_blank">xiaosoar</a></li>
				</ul>
			</footer>
		</div>

		<!-- Scripts -->
		<script src="assets/js/main.js"></script>
		<script>
			function toggleAdvanced() {
				const fields = document.getElementById('advanced-fields');
				fields.style.display = fields.style.display === 'none' ? 'block' : 'none';
			}
		</script>
	</body>
</html>
